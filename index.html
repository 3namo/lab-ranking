<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>é¸è€ƒçŠ¶æ³ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        :root {
            --border-color: #ddd; --bg-color: #f4f7f6; --bg-alt-color: #fff;
            --text-color: #333; --accent-color: #007bff; --danger-color: #e74c3c;
        }
        body { 
            font-family: 'Segoe UI', Meiryo, sans-serif; 
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            line-height: 1.6;
        }
        .container { 
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 0 1rem; 
            box-sizing: border-box;
        }
        h1, h2 { 
            text-align: center; 
            color: #444; 
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }
        h2 { 
            font-size: 1.4rem;
            margin-top: 2.5rem; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 0.5rem; 
        }
        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 1.5rem 0; 
            flex-wrap: wrap; 
            gap: 0.75rem;
        }
        .search-bar { 
            flex-grow: 1; 
            min-width: 180px;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color); 
            border-radius: 20px; 
            font-size: 1rem;
        }
        .toolbar-group { 
            display: flex; 
            gap: 0.5rem;
            flex-wrap: wrap; 
        }
        .toolbar-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color); 
            background-color: var(--bg-alt-color);
            border-radius: 20px; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .toolbar-btn:hover { background-color: #e9ecef; }
        #company-list, #archived-list { margin-top: 1rem; }
        .company-item {
            background-color: var(--bg-alt-color); 
            border: 1px solid var(--border-color);
            border-left-width: 5px; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            transition: box-shadow 0.2s;
        }
        .item-summary { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            padding: 0.75rem 1rem;
            cursor: pointer; 
            flex-wrap: wrap; 
        }
        .company-name { 
            font-weight: bold; 
            font-size: 1.1rem;
            flex-grow: 2;
            min-width: 150px;
            padding: 0.25rem; 
        }
        .status-select { 
            padding: 0.5rem; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 0.9rem; 
            min-width: 100px;
            flex-shrink: 0;
            margin-left: auto;
        }
        .action-btn { 
            background: none; 
            border: none; 
            color: #aaa; 
            cursor: pointer; 
            font-size: 1.2rem; 
            padding: 0 0.25rem;
            transition: color 0.2s; 
            vertical-align: middle; 
            flex-shrink: 0;
        }
        .edit-name-btn:hover { color: var(--accent-color); }
        .kebab-btn { 
            font-size: 1.5rem; 
            font-weight: bold; 
            border-radius: 50%; 
            width: 36px;
            height: 36px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0;
            margin-left: 0;
            margin-right: -0.25rem;
        }
        .kebab-btn:hover { background-color: #f0f0f0; }
        .menu-container { position: relative; flex-shrink: 0; }
        .kebab-menu {
            display: none; 
            position: absolute; 
            right: 0; 
            top: 100%; 
            background: white;
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 10; 
            list-style: none; 
            padding: 0.5rem 0; 
            margin: 0; 
            min-width: 150px;
        }
        .kebab-menu.show { display: block; }
        .kebab-menu button { 
            display: block; 
            width: 100%; 
            text-align: left; 
            padding: 0.75rem 1rem; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-size: 0.95rem;
        }
        .kebab-menu button:hover { background-color: #f0f0f0; }
        .kebab-menu button.delete { color: var(--danger-color); }
        .item-details { 
            padding: 0 1rem 1rem 1rem; 
            border-top: 1px dashed var(--border-color); 
            margin-top: 0.5rem; 
        }
        .detail-grid { 
            display: grid; 
            gap: 1rem; 
            grid-template-columns: 1fr;
        }
        @media (min-width: 600px) {
            .detail-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .detail-field { display: flex; flex-direction: column; }
        .detail-field label { 
            font-size: 0.85rem;
            color: #666; 
            margin-bottom: 0.25rem; 
        }
        .detail-field input { 
            width: 100%; 
            padding: 0.6rem;
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 0.9rem;
            box-sizing: border-box; 
        }
        .url-field { 
            grid-column: 1 / -1; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .url-link { font-size: 1.2rem; text-decoration: none; }
        .add-container { 
            text-align: center; 
            margin-top: 1rem; 
        }
        #add-company-btn { 
            background-color: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 2.2rem;
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            line-height: 1;
            /* ã“ã“ã‚’ä¿®æ­£ï¼šãƒœã‚¿ãƒ³è‡ªä½“ã‚’ä¸­å¤®å¯„ã› */
            margin: 0 auto; 
            display: block; /* text-align: center; ã§ä¸­å¤®å¯„ã›ã™ã‚‹ãŸã‚ã«ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã™ã‚‹ */
        }
        #add-company-btn:hover { background-color: #0056b3; }
        #add-company-form { 
            display: none; 
            flex-direction: row;
            flex-wrap: wrap;
            gap: 0.75rem; 
            align-items: center;
            justify-content: center;
            padding: 1.2rem; 
            background-color: #fff; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            max-width: 600px;
            margin: 0 auto; 
            box-sizing: border-box;
        }
        #new-company-name { 
            padding: 0.75rem;
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 1rem; 
            flex-grow: 1; 
            min-width: 150px;
            box-sizing: border-box;
        }
        .form-btn { 
            padding: 0.75rem 1.2rem;
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1rem;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .add-new-btn { background-color: var(--accent-color); color: white; }
        .cancel-add-btn { background-color: #6c757d; color: white; }
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6);
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background: white; 
            padding: 1.5rem;
            border-radius: 8px; 
            width: 90%; 
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            box-sizing: border-box;
        }
        .modal-content h3 { margin-top: 0; font-size: 1.3rem; }
        #status-options-list { 
            list-style: none; 
            padding: 0; 
            max-height: 250px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 0.95rem;
        }
        #status-options-list li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border-color); 
            cursor: move; 
        }
        #status-options-list li:last-child { border-bottom: none; }
        #status-options-list li .delete-btn { 
            font-size: 1.1rem; 
            padding: 0.2rem 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #aaa;
        }
        #status-options-list li .delete-btn:hover { color: var(--danger-color); }
        #add-status-form { 
            display: flex; 
            gap: 0.5rem; 
            margin-top: 1rem; 
        }
        .modal-footer { margin-top: 1.5rem; text-align: right; }
        #toast-container { 
            position: fixed; 
            bottom: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 2000; 
            display: flex; 
            flex-direction: column-reverse; 
            align-items: center; 
            width: 90%; 
            max-width: 350px;
        }
        .toast {
            background-color: rgba(0,0,0,0.85);
            color: white; 
            padding: 0.8rem 1.2rem;
            border-radius: 8px; 
            margin-top: 0.5rem; 
            opacity: 0;
            animation: fadeInOut 3s forwards;
            font-size: 0.95rem;
            text-align: center;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é¸è€ƒçŠ¶æ³ç®¡ç†</h1>
        <div class="toolbar">
            <input type="search" id="search-bar" class="search-bar" placeholder="ä¼æ¥­åã‚’æ¤œç´¢...">
            <div class="toolbar-group">
                <button id="manage-status-btn" class="toolbar-btn">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</button>
                <button id="sort-by-name" class="toolbar-btn">åå‰é †</button>
                <button id="sort-by-date" class="toolbar-btn">äºˆå®šæ—¥é †</button>
            </div>
        </div>
        <div id="company-list"></div>
        <div class="add-container">
            <button id="add-company-btn" title="ä¼æ¥­ã‚’è¿½åŠ ">+</button>
            <form id="add-company-form">
                <input type="text" id="new-company-name" placeholder="ä¼æ¥­åã‚’å…¥åŠ›" required>
                <button type="submit" class="form-btn add-new-btn">è¿½åŠ </button>
                <button type="button" id="cancel-add-btn" class="form-btn cancel-add-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
        <div id="archive-section" style="display: none;">
            <h2>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
            <div id="archived-list"></div>
        </div>
        <div style="text-align: center; margin: 1rem 0;">
            <button id="toggle-archive-btn" class="toolbar-btn">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
        </div>
        <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <div class="toolbar">
            <button id="export-data-btn" class="toolbar-btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="import-file-input" style="display: none;">
            <button id="import-data-btn" class="toolbar-btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
    </div>
    <div class="modal-overlay" id="manage-status-modal">
        <div class="modal-content">
            <h3>é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç®¡ç†</h3>
            <p>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆãŒã§ãã¾ã™ã€‚</p>
            <ul id="status-options-list"></ul>
            <form id="add-status-form">
                <input type="text" id="new-status-name" placeholder="æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å" required style="flex-grow:1; padding: 0.5rem;">
                <button type="submit" class="form-btn add-new-btn">è¿½åŠ </button>
            </form>
            <div class="modal-footer">
                <button id="close-modal-btn" class="toolbar-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- è¦ç´ å–å¾— ---
            const companyList = document.getElementById('company-list');
            const archivedList = document.getElementById('archived-list');
            const addCompanyBtn = document.getElementById('add-company-btn');
            const sortByNameBtn = document.getElementById('sort-by-name');
            const sortByDateBtn = document.getElementById('sort-by-date');
            const addCompanyForm = document.getElementById('add-company-form');
            const newCompanyNameInput = document.getElementById('new-company-name');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const manageStatusBtn = document.getElementById('manage-status-btn');
            const modal = document.getElementById('manage-status-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const statusOptionsList = document.getElementById('status-options-list');
            const addStatusForm = document.getElementById('add-status-form');
            const newStatusNameInput = document.getElementById('new-status-name');
            const searchBar = document.getElementById('search-bar');
            const archiveSection = document.getElementById('archive-section');
            const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
            const exportBtn = document.getElementById('export-data-btn');
            const importBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            const toastContainer = document.getElementById('toast-container');
    
            // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
            const DATA_KEY = 'jobAppData_v8';
            const defaultStatusOptions = ["æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆã¿", "æ›¸é¡é¸è€ƒ", "ã‚¦ã‚£ãƒ³ã‚¿ãƒ¼é€šé", "ã‚µãƒãƒ¼é€šé", "Webãƒ†ã‚¹ãƒˆ", "1æ¬¡é¢æ¥å‰", "1æ¬¡é¢æ¥çµæœå¾…ã¡", "1æ¬¡é¢æ¥é€šé", "2æ¬¡é¢æ¥å‰", "2æ¬¡é¢æ¥çµæœå¾…ã¡", "2æ¬¡é¢æ¥é€šé", "æœ€çµ‚é¢æ¥å‰", "æœ€çµ‚é¢æ¥çµæœå¾…ã¡", "å†…ã€…å®š", "å†…å®š", "ãŠç¥ˆã‚Š"];
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨è‰²ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å®šç¾©
            const statusColors = {
                "æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼": "#ccc",
                "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆã¿": "#ccc",
                "æ›¸é¡é¸è€ƒ": "#ccc",
                "ã‚µãƒãƒ¼é€šé": "#28a745", // ç·‘
                "ã‚¦ã‚£ãƒ³ã‚¿ãƒ¼é€šé": "#28a745", // ç·‘
                "å†…ã€…å®š": "#28a745", // ç·‘
                "å†…å®š": "#28a745", // ç·‘
                "ãŠç¥ˆã‚Š": "#e74c3c", // èµ¤
                "Webãƒ†ã‚¹ãƒˆ": "#87CEEB", // è–„ã„é’
                "1æ¬¡é¢æ¥å‰": "#87CEEB", // è–„ã„é’
                "1æ¬¡é¢æ¥çµæœå¾…ã¡": "#87CEEB", // è–„ã„é’
                "2æ¬¡é¢æ¥å‰": "#87CEEB", // è–„ã„é’
                "2æ¬¡é¢æ¥çµæœå¾…ã¡": "#87CEEB", // è–„ã„é’
                "æœ€çµ‚é¢æ¥å‰": "#87CEEB", // è–„ã„é’
                "æœ€çµ‚é¢æ¥çµæœå¾…ã¡": "#87CEEB", // è–„ã„é’
                "1æ¬¡é¢æ¥é€šé": "#4682B4", // Steel Blue - å°‘ã—æ¿ƒã„ã‚ã®é’
                "2æ¬¡é¢æ¥é€šé": "#1E90FF"  // Dodger Blue - ã‚ˆã‚Šæ¿ƒã„é’
            };
    
            let appData = { companies: [], statusOptions: defaultStatusOptions };
    
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            const loadData = () => {
                const savedData = localStorage.getItem(DATA_KEY);
                if (savedData) {
                    appData = JSON.parse(savedData);
                    // ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§statusOptionsãŒãªã„å ´åˆã«å¯¾å¿œ
                    if (!appData.statusOptions) {
                        appData.statusOptions = defaultStatusOptions;
                    }
                }
            };
    
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
            const saveData = () => localStorage.setItem(DATA_KEY, JSON.stringify(appData));
    
            // --- æç”»é–¢æ•° ---
            // å…¨ã¦ã®ä¼æ¥­ãƒªã‚¹ãƒˆã‚’å†æç”»ã™ã‚‹
            const render = () => {
                const searchTerm = searchBar.value.toLowerCase();
                renderCompanyList(companyList, appData.companies.filter(c => !c.archived), searchTerm);
                renderCompanyList(archivedList, appData.companies.filter(c => c.archived), searchTerm, true);
            };
    
            // ç‰¹å®šã®ãƒªã‚¹ãƒˆè¦ç´ ï¼ˆcompanyListã¾ãŸã¯archivedListï¼‰ã«ä¼æ¥­ã‚’è¡¨ç¤ºã™ã‚‹
            const renderCompanyList = (listElement, companies, searchTerm, isArchived = false) => {
                // æ¤œç´¢èªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const filteredCompanies = companies.filter(c => c.name.toLowerCase().includes(searchTerm));
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                listElement.innerHTML = filteredCompanies.length === 0 ? `<p style="text-align:center; color:#888;">${searchTerm ? 'è©²å½“ãªã—' : 'ä¼æ¥­ãªã—'}</p>` : '';
                
                // å„ä¼æ¥­ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
                filteredCompanies.forEach(company => {
                    const companyEl = document.createElement('details');
                    companyEl.classList.add('company-item');
                    companyEl.dataset.id = company.id; // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«IDã‚’ä¿å­˜
                    companyEl.style.borderLeftColor = statusColors[company.status] || '#ccc'; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã‚’è¨­å®š
    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠè‚¢ã®HTMLã‚’ç”Ÿæˆ
                    const optionsHtml = appData.statusOptions.map(o => `<option value="${o}" ${company.status === o ? 'selected' : ''}>${o}</option>`).join('');
                    
                    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ±ºå®š
                    const archiveMenuText = isArchived ? 'ãƒªã‚¹ãƒˆã«æˆ»ã™' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–';
    
                    companyEl.innerHTML = `
                        <summary class="item-summary">
                            <span class="company-name">${company.name}</span>
                            <button class="action-btn edit-name-btn" title="åå‰ã‚’ç·¨é›†">âœï¸</button>
                            <select class="status-select">${optionsHtml}</select>
                            <div class="menu-container">
                                <button class="kebab-btn action-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â‹®</button>
                                <div class="kebab-menu">
                                    <button class="menu-item-archive">${archiveMenuText}</button>
                                    <button class="menu-item-delete delete">å®Œå…¨ã«å‰Šé™¤</button>
                                </div>
                            </div>
                        </summary>
                        <div class="item-details">
                            <div class="detail-grid">
                                <div class="detail-field"><label>ID/Email</label><input type="text" class="login-id" value="${company.loginId || ''}"></div>
                                <div class="detail-field"><label>ä¸€è¡Œãƒ¡ãƒ¢</label><input type="text" class="memo-input" value="${company.memo || ''}"></div>
                                <div class="detail-field"><label>æ¬¡å›ã®äºˆå®šæ—¥</label><input type="date" class="next-date" value="${company.nextDate || ''}"></div>
                                <div class="detail-field url-field"><label>æ¡ç”¨URL</label><input type="url" class="url-input" value="${company.url || ''}"><a href="${company.url || '#'}" target="_blank" class="url-link">ğŸ”—</a></div>
                            </div>
                        </div>`;
                    listElement.appendChild(companyEl);
                });
            };
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å†æç”»ã™ã‚‹
            const renderStatusOptionsInModal = () => {
                statusOptionsList.innerHTML = '';
                appData.statusOptions.forEach(name => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${name}</span><button data-name="${name}" class="delete-btn">&times;</button>`;
                    statusOptionsList.appendChild(li);
                });
            };
    
            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
            const showToast = (message) => {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                toastContainer.appendChild(toast);
                // 3ç§’å¾Œã«ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
                setTimeout(() => { toast.remove(); }, 3000);
            };
    
            // ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’å‡¦ç†ã™ã‚‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ID/Emailã€ãƒ¡ãƒ¢ã€äºˆå®šæ—¥ã€URLï¼‰
            const handleCompanyDataChange = (e) => {
                const itemEl = e.target.closest('.company-item');
                if (!itemEl) return;
                const company = appData.companies.find(c => c.id == itemEl.dataset.id);
    
                // å¤‰æ›´ã•ã‚ŒãŸè¦ç´ ã®ã‚¯ãƒ©ã‚¹åã¨ã€ãã‚Œã«å¯¾å¿œã™ã‚‹companyã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
                const propMap = {
                    'status-select':'status',
                    'login-id':'loginId',
                    'next-date':'nextDate',
                    'url-input':'url',
                    'memo-input':'memo'
                };
    
                for (const [cls, prop] of Object.entries(propMap)) {
                    if (e.target.classList.contains(cls)) {
                        company[prop] = e.target.value;
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã«ã¯å·¦ãƒœãƒ¼ãƒ€ãƒ¼ã®è‰²ã‚’æ›´æ–°
                        if(cls === 'status-select') {
                            itemEl.style.borderLeftColor = statusColors[company.status] || '#ccc';
                        }
                        // URLå¤‰æ›´æ™‚ã«ã¯ãƒªãƒ³ã‚¯ã®hrefã‚’æ›´æ–°
                        if(cls === 'url-input') {
                            itemEl.querySelector('.url-link').href = e.target.value || '#';
                        }
                        break;
                    }
                }
                saveData(); // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ä¿å­˜
            };
    
            // ãƒªã‚¹ãƒˆå†…ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ï¼ˆåå‰ç·¨é›†ã€ã‚±ãƒãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã€å‰Šé™¤ï¼‰
            const handleListClick = (e) => {
                const editBtn = e.target.closest('.edit-name-btn');
                const kebabBtn = e.target.closest('.kebab-btn');
                const menuItemArchive = e.target.closest('.menu-item-archive');
                const menuItemDelete = e.target.closest('.menu-item-delete');
    
                if (editBtn) {
                    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œï¼ˆdetailsã®é–‹é–‰ï¼‰ã‚’é˜²æ­¢
                    const itemEl = e.target.closest('.company-item');
                    const nameSpan = itemEl.querySelector('.company-name');
                    const currentName = nameSpan.textContent;
    
                    // åå‰ç·¨é›†ç”¨ã®inputè¦ç´ ã‚’ä½œæˆ
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentName;
                    input.style.cssText = 'font-weight: bold; font-size: 1.1rem; flex-grow: 1; border: 1px solid #007bff; padding: 0.25rem; border-radius: 4px;';
                    
                    // spanã‚’inputã«ç½®ãæ›ãˆã‚‹
                    nameSpan.replaceWith(input);
                    input.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
    
                    const saveNameChange = () => {
                        const newName = input.value.trim();
                        if (newName && newName !== currentName) {
                            const company = appData.companies.find(c => c.id == itemEl.dataset.id);
                            company.name = newName;
                            saveData(); // åå‰å¤‰æ›´ã‚’ä¿å­˜
                        }
                        render(); // ãƒªã‚¹ãƒˆã‚’å†æç”»ã—ã¦å¤‰æ›´ã‚’åæ˜ 
                    };
    
                    input.addEventListener('blur', saveNameChange); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ä¿å­˜
                    input.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter') {
                            input.blur(); // Enterã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ä¿å­˜
                        } else if (event.key === 'Escape') {
                            input.value = currentName; // Escã‚­ãƒ¼ã§å…ƒã®åå‰ã«æˆ»ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
                            input.blur();
                        }
                    });
                } else if (kebabBtn) {
                    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’é˜²æ­¢
                    const menu = kebabBtn.nextElementSibling; // ã‚±ãƒãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ ã‚’å–å¾—
                    const isShown = menu.classList.contains('show');
    
                    // ä»–ã®é–‹ã„ã¦ã„ã‚‹ã‚±ãƒãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å…¨ã¦é–‰ã˜ã‚‹
                    document.querySelectorAll('.kebab-menu.show').forEach(m => m.classList.remove('show'));
    
                    // ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰ã™ã‚‹
                    if (!isShown) {
                        menu.classList.add('show');
                    }
                } else if (menuItemArchive) {
                    const company = appData.companies.find(c => c.id == e.target.closest('.company-item').dataset.id);
                    company.archived = !company.archived; // archivedçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
                    saveData();
                    render(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
                    showToast(`ã€Œ${company.name}ã€ã‚’${company.archived ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ' : 'ãƒªã‚¹ãƒˆã«æˆ»ã—ã¾ã—ãŸ'}`);
                } else if (menuItemDelete) {
                    const itemEl = e.target.closest('.company-item');
                    const id = itemEl.dataset.id;
                    const companyName = appData.companies.find(c => c.id == id).name;
                    if (confirm(`ã€Œ${companyName}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                        appData.companies = appData.companies.filter(c => c.id != id); // è©²å½“ä¼æ¥­ã‚’å‰Šé™¤
                        saveData();
                        render(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
                        showToast(`ã€Œ${companyName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    }
                }
            };
            
            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
            companyList.addEventListener('change', handleCompanyDataChange); // é€šå¸¸ãƒªã‚¹ãƒˆã®å¤‰æ›´
            archivedList.addEventListener('change', handleCompanyDataChange); // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚¹ãƒˆã®å¤‰æ›´
            companyList.addEventListener('click', handleListClick); // é€šå¸¸ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯
            archivedList.addEventListener('click', handleListClick); // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯
            
            // ã‚±ãƒãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.menu-container')) {
                    document.querySelectorAll('.kebab-menu.show').forEach(menu => menu.classList.remove('show'));
                }
            });
    
            // ä¼æ¥­è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
            addCompanyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const companyName = newCompanyNameInput.value.trim();
                if (companyName) {
                    appData.companies.push({ 
                        id: Date.now(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
                        name: companyName,
                        loginId: '', 
                        status: appData.statusOptions[0], // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
                        url: '',
                        nextDate: '', 
                        memo: '',
                        archived: false // åˆæœŸçŠ¶æ…‹ã§ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚Œã¦ã„ãªã„
                    });
                    saveData();
                    render();
                    hideAddForm(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«æˆ»ã™
                }
            });
    
            // ä¼æ¥­è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const showAddForm = () => {
                addCompanyBtn.style.display = 'none';
                addCompanyForm.style.display = 'flex';
                newCompanyNameInput.focus();
            };
            const hideAddForm = () => {
                addCompanyBtn.style.display = 'block'; // å…ƒã®displayãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æˆ»ã™
                addCompanyForm.style.display = 'none';
                newCompanyNameInput.value = ''; // å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
            };
            addCompanyBtn.addEventListener('click', showAddForm); // è¿½åŠ ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
            cancelAddBtn.addEventListener('click', hideAddForm); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤º
    
            // åå‰é †ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            sortByNameBtn.addEventListener('click', () => {
                appData.companies.sort((a,b) => a.name.localeCompare(b.name, 'ja'));
                render();
            });
    
            // äºˆå®šæ—¥é †ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            sortByDateBtn.addEventListener('click', () => {
                appData.companies.sort((a,b) => {
                    if (!a.nextDate) return 1; // æ—¥ä»˜ãŒãªã„ã‚‚ã®ã¯å¾Œã‚ã«
                    if (!b.nextDate) return -1; // æ—¥ä»˜ãŒãªã„ã‚‚ã®ã¯å¾Œã‚ã«
                    return new Date(a.nextDate) - new Date(b.nextDate); // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
                });
                render();
            });
    
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
            manageStatusBtn.addEventListener('click', () => {
                renderStatusOptionsInModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ€æ–°ã®çŠ¶æ…‹ã«ã™ã‚‹
                modal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            });
    
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
    
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
    
            // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
            addStatusForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = newStatusNameInput.value.trim();
                if (newName && !appData.statusOptions.includes(newName)) { // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    appData.statusOptions.push(newName); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ 
                    saveData();
                    renderStatusOptionsInModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è¡¨ç¤ºã‚’æ›´æ–°
                    render(); // ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°
                    newStatusNameInput.value = ''; // å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
                }
            });
    
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
            statusOptionsList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const statusToDelete = e.target.closest('.delete-btn').dataset.name;
                    if (confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œ${statusToDelete}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        appData.statusOptions = appData.statusOptions.filter(name => name !== statusToDelete); // è©²å½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰Šé™¤
                        saveData();
                        renderStatusOptionsInModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è¡¨ç¤ºã‚’æ›´æ–°
                        render(); // ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°
                    }
                }
            });
    
            // Sortable.jsã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½
            new Sortable(statusOptionsList, {
                animation: 150,
                onEnd: (evt) => {
                    const [movedItem] = appData.statusOptions.splice(evt.oldIndex, 1); // ç§»å‹•å…ƒã‹ã‚‰å‰Šé™¤
                    appData.statusOptions.splice(evt.newIndex, 0, movedItem); // ç§»å‹•å…ˆã«æŒ¿å…¥
                    saveData();
                    render(); // ä¸¦ã³æ›¿ãˆã‚’åæ˜ ã™ã‚‹ãŸã‚å†æç”»
                }
            });
    
            // æ¤œç´¢ãƒãƒ¼ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
            searchBar.addEventListener('input', render);
    
            // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚¹ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
            toggleArchiveBtn.addEventListener('click', () => {
                const isHidden = archiveSection.style.display === 'none';
                archiveSection.style.display = isHidden ? 'block' : 'none';
                toggleArchiveBtn.textContent = isHidden ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’éš ã™' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º';
            });
    
            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(appData, null, 2); // ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆæ•´å½¢ã—ã¦å¯èª­æ€§å‘ä¸Šï¼‰
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `job-applications-backup-${new Date().toISOString().slice(0,10)}.json`; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                a.click();
                URL.revokeObjectURL(url); // URLã‚’è§£æ”¾
            });
    
            // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            importBtn.addEventListener('click', () => importFileInput.click()); // éš ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
    
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result); // èª­ã¿è¾¼ã‚“ã JSONã‚’ãƒ‘ãƒ¼ã‚¹
                        if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                            appData = importedData; // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
                            saveData();
                            render(); // å†æç”»
                            alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                        }
                    } catch (err) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æœ‰åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    }
                };
                reader.readAsText(file); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€
                importFileInput.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
            });
    
            // --- åˆæœŸåŒ–å‡¦ç† ---
            loadData(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            render();   // ä¼æ¥­ãƒªã‚¹ãƒˆã‚’åˆæœŸæç”»
        });
    </script>
</body>
</html>
